name: RDPXD

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
            -Name fDenyTSConnections -Value 0
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          Restart-Service TermService -Force

      - name: Create RDP User
        shell: pwsh
        run: |
          $user = "RDP"
          $pass = "Abc@1234Xy!"

          net user $user /delete 2>$null
          net user $user $pass /add
          net localgroup Administrators $user /add
          net localgroup "Remote Desktop Users" $user /add

          echo "RDP_USER=$user" >> $env:GITHUB_ENV
          echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

      - name: Install 7-Zip for RAR extraction
        shell: pwsh
        run: |
          $7zUrl = "https://www.7-zip.org/a/7z2407-x64.exe"
          $7zPath = "$env:TEMP\7z.exe"
          Invoke-WebRequest -Uri $7zUrl -OutFile $7zPath
          Start-Process -FilePath $7zPath -ArgumentList "/S" -Wait
          Write-Host "7-Zip installed successfully"

      - name: Download XDumpGO RAR from MediaFire
        shell: pwsh
        run: |
          # Try direct download first
          $directUrl = "https://download2264.mediafire.com/m6jgrzle2lveqe2/x10g5we6bis/XDumpGO.rar"
          $rarPath = "C:\XDumpGO.rar"
          
          Write-Host "Downloading XDumpGO RAR from direct link..."
          try {
              Invoke-WebRequest -Uri $directUrl -OutFile $rarPath
          } catch {
              Write-Host "Direct download failed, trying alternative..."
              $mediafireUrl = "https://www.mediafire.com/file/m6jgrzle2lveqe2/XDumpGO.rar/file?dkey=x10g5we6bis&r=1279"
              $pageContent = Invoke-WebRequest -Uri $mediafireUrl -UseBasicParsing
              
              if ($pageContent.Content -match 'href="(https://download[^"]+\.rar)"') {
                  $downloadUrl = $matches[1]
                  Write-Host "Found download URL: $downloadUrl"
                  Invoke-WebRequest -Uri $downloadUrl -OutFile $rarPath
              } else {
                  Write-Host "Creating manual download instructions..."
                  $instructions = "Download XDumpGO from: https://www.mediafire.com/file/m6jgrzle2lveqe2/XDumpGO.rar/file?dkey=x10g5we6bis&r=1279"
                  $instructions | Out-File "C:\Download_Instructions.txt" -Encoding UTF8
              }
          }
          
          if (Test-Path $rarPath) {
              $fileSize = (Get-Item $rarPath).Length
              Write-Host "✅ Download successful: $fileSize bytes"
          } else {
              Write-Host "⚠️ Download may have failed, continuing anyway..."
          }

      - name: Extract XDumpGO
        shell: pwsh
        run: |
          $rarPath = "C:\XDumpGO.rar"
          $extractPath = "C:\XDumpGO"
          
          if (Test-Path $rarPath) {
              Write-Host "Extracting XDumpGO..."
              New-Item -ItemType Directory -Path $extractPath -Force | Out-Null
              & "C:\Program Files\7-Zip\7z.exe" x $rarPath -o"$extractPath" -y
              Write-Host "Extraction complete!"
              
              # List files
              Write-Host "Extracted files:"
              Get-ChildItem $extractPath -File | Select-Object -First 10 Name, Length | Format-Table
              
              # Check for XDumpGO.exe
              $exeFile = Get-ChildItem $extractPath -Filter "*.exe" -Recurse | Select-Object -First 1
              if ($exeFile) {
                  Write-Host "✅ Found executable: $($exeFile.FullName)"
              }
              
              Remove-Item $rarPath -Force -ErrorAction SilentlyContinue
          } else {
              Write-Host "⚠️ RAR file not found. Creating empty directory for manual download."
              New-Item -ItemType Directory -Path $extractPath -Force | Out-Null
          }

      - name: Setup XDumpGO for RDP User
        shell: pwsh
        run: |
          # Create RDP user desktop folder
          $rdpDesktop = "C:\Users\RDP\Desktop"
          New-Item -ItemType Directory -Path $rdpDesktop -Force | Out-Null
          
          # Copy XDumpGO to RDP desktop
          $sourcePath = "C:\XDumpGO"
          $destPath = "$rdpDesktop\XDumpGO"
          
          if (Test-Path $sourcePath) {
              Write-Host "Copying XDumpGO to RDP desktop..."
              Copy-Item -Path $sourcePath -Destination $destPath -Recurse -Force
              
              # Find executable
              $exeFiles = Get-ChildItem $destPath -Filter "*.exe" -Recurse
              if ($exeFiles) {
                  $mainExe = $exeFiles | Where-Object { $_.Name -like "*XDumpGO*" } | Select-Object -First 1
                  if ($mainExe) {
                      $exePath = $mainExe.FullName
                      Write-Host "✅ Main executable: $exePath"
                      
                      # Create shortcut
                      $WshShell = New-Object -ComObject WScript.Shell
                      $Shortcut = $WshShell.CreateShortcut("$rdpDesktop\XDumpGO.lnk")
                      $Shortcut.TargetPath = $exePath
                      $Shortcut.WorkingDirectory = $destPath
                      $Shortcut.Save()
                      
                      # Also create on public desktop
                      $publicDesktop = "C:\Users\Public\Desktop"
                      $PublicShortcut = $WshShell.CreateShortcut("$publicDesktop\XDumpGO.lnk")
                      $PublicShortcut.TargetPath = $exePath
                      $PublicShortcut.WorkingDirectory = $destPath
                      $PublicShortcut.Save()
                      
                      # Add to startup
                      reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v XDumpGO /t REG_SZ /d "`"$exePath`"" /f
                      
                      Write-Host "✅ Setup complete: Shortcuts created and added to startup"
                  }
              }
          }

      - name: Check and Install Required Dependencies
        shell: pwsh
        run: |
          Write-Host "Checking for required dependencies..."
          
          # Check for Visual C++ Redistributable
          $vcRedist = Get-WmiObject -Class Win32_Product | Where-Object { $_.Name -like "*Visual C++*" }
          if (-not $vcRedist) {
              Write-Host "Installing Visual C++ Redistributable..."
              $vcUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
              $vcPath = "$env:TEMP\vc_redist.exe"
              Invoke-WebRequest -Uri $vcUrl -OutFile $vcPath
              Start-Process -FilePath $vcPath -ArgumentList "/install /quiet /norestart" -Wait
          }
          
          # Check for .NET Framework
          $dotnet = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" -ErrorAction SilentlyContinue
          if (-not $dotnet) {
              Write-Host ".NET Framework 4.8 might be needed..."
          }

      - name: Test XDumpGO Startup
        shell: pwsh
        run: |
          Write-Host "Testing XDumpGO startup..."
          
          # Find executable
          $exePath = Get-ChildItem "C:\Users\RDP\Desktop\XDumpGO" -Filter "*.exe" -Recurse | Where-Object { $_.Name -like "*XDumpGO*" } | Select-Object -First 1 -ExpandProperty FullName
          
          if ($exePath) {
              Write-Host "Found executable: $exePath"
              
              # Try to run with different methods
              Write-Host "Attempt 1: Direct start..."
              try {
                  $process1 = Start-Process -FilePath $exePath -WindowStyle Normal -PassThru -ErrorAction Stop
                  Write-Host "✅ Process started with PID: $($process1.Id)"
                  Start-Sleep -Seconds 5
              } catch {
                  Write-Host "❌ Direct start failed: $_"
              }
              
              Write-Host "Attempt 2: Start with working directory..."
              try {
                  $workingDir = Split-Path $exePath -Parent
                  $process2 = Start-Process -FilePath $exePath -WorkingDirectory $workingDir -PassThru -ErrorAction Stop
                  Write-Host "✅ Process started with working directory"
                  Start-Sleep -Seconds 5
              } catch {
                  Write-Host "❌ Working directory start failed: $_"
              }
              
              Write-Host "Attempt 3: Start minimized..."
              try {
                  $process3 = Start-Process -FilePath $exePath -WindowStyle Minimized -PassThru -ErrorAction Stop
                  Write-Host "✅ Process started minimized"
              } catch {
                  Write-Host "❌ Minimized start failed: $_"
              }
              
          } else {
              Write-Host "⚠️ No XDumpGO executable found"
          }
          
          Write-Host "Test complete. XDumpGO will auto-start when RDP user logs in."

      - name: Install Tailscale
        shell: pwsh
        run: |
          Write-Host "Installing Tailscale..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $path = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest $url -OutFile $path
          Start-Process msiexec.exe -ArgumentList "/i `"$path`" /quiet /norestart" -Wait

      - name: Connect Tailscale
        shell: pwsh
        run: |
          Write-Host "Connecting Tailscale..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=gh-rdp-$env:GITHUB_RUN_ID
          
          Start-Sleep 10
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "✅ Tailscale connected with IP: $ip"

      - name: Show RDP Details
        shell: pwsh
        run: |
          Write-Host "=========================================="
          Write-Host "           RDP ACCESS READY               "
          Write-Host "=========================================="
          Write-Host "RDP IP Address : $env:TAILSCALE_IP"
          Write-Host "Username       : $env:RDP_USER"
          Write-Host "Password       : $env:RDP_PASS"
          Write-Host "------------------------------------------"
          Write-Host "XDumpGO Setup:"
          Write-Host "- Location: C:\Users\RDP\Desktop\XDumpGO\"
          Write-Host "- Desktop shortcut: XDumpGO.lnk"
          Write-Host "- Auto-start: Configured (runs on login)"
          Write-Host "- Note: May need RDP session for GUI"
          Write-Host "------------------------------------------"
          Write-Host "To Use:"
          Write-Host "1. Connect via RDP to: $env:TAILSCALE_IP"
          Write-Host "2. Login with above credentials"
          Write_Host "3. Double-click XDumpGO shortcut on desktop"
          Write-Host "4. If doesn't start, run as administrator"
          Write-Host "=========================================="
          
          # Keep alive without monitoring XDumpGO
          $counter = 0
          while ($true) { 
              $counter++
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP Ready - $counter - IP: $env:TAILSCALE_IP"
              Start-Sleep 60
          }
