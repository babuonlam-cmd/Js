name: RDPXD

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
            -Name fDenyTSConnections -Value 0
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          Restart-Service TermService -Force

      - name: Create RDP User
        shell: pwsh
        run: |
          $user = "RDP"
          $pass = "Abc@1234Xy!"

          net user $user /delete 2>$null
          net user $user $pass /add
          net localgroup Administrators $user /add
          net localgroup "Remote Desktop Users" $user /add

          echo "RDP_USER=$user" >> $env:GITHUB_ENV
          echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

      - name: Install 7-Zip for RAR extraction
        shell: pwsh
        run: |
          $7zUrl = "https://www.7-zip.org/a/7z2407-x64.exe"
          $7zPath = "$env:TEMP\7z.exe"
          Invoke-WebRequest -Uri $7zUrl -OutFile $7zPath
          Start-Process -FilePath $7zPath -ArgumentList "/S" -Wait
          Write-Host "7-Zip installed successfully"

      - name: Download XDumpGO RAR from MediaFire
        shell: pwsh
        run: |
          $mediafireUrl = "https://www.mediafire.com/file/m6jgrzle2lveqe2/XDumpGO.rar/file?dkey=x10g5we6bis&r=1279"
          Write-Host "Downloading XDumpGO RAR from MediaFire..."
          $rarPath = "C:\Users\Public\Desktop\XDumpGO.rar"
          
          try {
              $pageContent = Invoke-WebRequest -Uri $mediafireUrl -UseBasicParsing
              
              if ($pageContent.Content -match 'href="(https://download[^"]+\.rar)"') {
                  $downloadUrl = $matches[1]
                  Write-Host "Found download URL: $downloadUrl"
                  Invoke-WebRequest -Uri $downloadUrl -OutFile $rarPath
              } else {
                  Write-Host "Could not extract download link. Creating manual download instructions..."
                  
                  $instructions = "XDumpGO Download Instructions:`n1. Open browser in RDP`n2. Go to: https://www.mediafire.com/file/m6jgrzle2lveqe2/XDumpGO.rar/file?dkey=x10g5we6bis&r=1279`n3. Click download`n4. Save to Desktop`n5. Extract using 7-Zip"
                  
                  $instructions | Out-File "C:\Users\Public\Desktop\Download_XDumpGO.txt" -Encoding UTF8
                  throw "Automatic download failed. Manual download required."
              }
          } catch {
              Write-Host "Error: $_"
              throw "Download failed"
          }
          
          if (Test-Path $rarPath) {
              $fileSize = (Get-Item $rarPath).Length
              Write-Host "‚úÖ Download successful: $fileSize bytes"
          } else {
              throw "‚ùå Download failed: File not found"
          }

      - name: Extract XDumpGO to Desktop
        shell: pwsh
        run: |
          $rarPath = "C:\Users\Public\Desktop\XDumpGO.rar"
          $extractPath = "C:\Users\RDP\Desktop\XDumpGO"
          
          # Create RDP user desktop folder
          New-Item -ItemType Directory -Path "C:\Users\RDP\Desktop" -Force | Out-Null
          
          if (Test-Path $rarPath) {
              Write-Host "Extracting XDumpGO to Desktop..."
              New-Item -ItemType Directory -Path $extractPath -Force | Out-Null
              & "C:\Program Files\7-Zip\7z.exe" x $rarPath -o"$extractPath" -y
              Write-Host "Extraction complete!"
              
              # List extracted files
              Write-Host "Files on Desktop:"
              Get-ChildItem $extractPath | Select-Object Name, Length | Format-Table
              
              # Cleanup RAR file
              Remove-Item $rarPath -Force
          } else {
              Write-Host "RAR file not found. Skipping extraction."
          }

      - name: Start XDumpGO from Desktop
        shell: pwsh
        run: |
          $xdumpgoPath = "C:\Users\RDP\Desktop\XDumpGO\XDumpGO.exe"
          
          if (Test-Path $xdumpgoPath) {
              Write-Host "üöÄ Starting XDumpGO from Desktop..."
              Start-Process -FilePath $xdumpgoPath -WindowStyle Normal
              
              # Create additional shortcut (optional)
              $WshShell = New-Object -ComObject WScript.Shell
              $Shortcut = $WshShell.CreateShortcut("C:\Users\Public\Desktop\XDumpGO.lnk")
              $Shortcut.TargetPath = $xdumpgoPath
              $Shortcut.WorkingDirectory = "C:\Users\RDP\Desktop\XDumpGO"
              $Shortcut.Save()
              
              # Add to startup
              reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v XDumpGO /t REG_SZ /d "`"$xdumpgoPath`"" /f
              
              Write-Host "‚úÖ XDumpGO started from Desktop"
          } else {
              Write-Host "‚ö†Ô∏è XDumpGO.exe not found on Desktop. Checking folder:"
              Get-ChildItem "C:\Users\RDP\Desktop\XDumpGO" -Recurse | Where-Object { $_.Name -like "*.exe" } | Select-Object Name, FullName | Format-Table
              
              # Try to find any executable
              $exeFiles = Get-ChildItem "C:\Users\RDP\Desktop\XDumpGO" -Recurse -Filter "*.exe" | Select-Object -First 1
              if ($exeFiles) {
                  Write-Host "Found executable: $($exeFiles.FullName)"
                  Start-Process -FilePath $exeFiles.FullName
              }
          }

      - name: Install Tailscale
        shell: pwsh
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $path = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest $url -OutFile $path
          Start-Process msiexec.exe -ArgumentList "/i `"$path`" /quiet /norestart" -Wait

      - name: Connect Tailscale
        shell: pwsh
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=gh-rdp-$env:GITHUB_RUN_ID
          
          Start-Sleep 10
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: Show RDP Details
        shell: pwsh
        run: |
          Write-Host "=========================================="
          Write-Host "           RDP ACCESS READY               "
          Write-Host "=========================================="
          Write-Host "RDP IP Address : $env:TAILSCALE_IP"
          Write-Host "Username       : $env:RDP_USER"
          Write-Host "Password       : $env:RDP_PASS"
          Write-Host "------------------------------------------"
          Write-Host "XDumpGO Status :"
          
          $process = Get-Process | Where-Object { $_.Path -like "*XDumpGO*" }
          if ($process) {
              Write-Host "- ‚úÖ Running (PID: $($process.Id))"
          } else {
              Write-Host "- ‚ö†Ô∏è Not running - will start on RDP login"
          }
          
          Write-Host "- üìÅ Location: C:\Users\RDP\Desktop\XDumpGO\XDumpGO.exe"
          Write-Host "- üîó Desktop folder: XDumpGO"
          Write-Host "------------------------------------------"
          Write-Host "Instructions:"
          Write-Host "1. Connect via RDP to: $env:TAILSCALE_IP"
          Write-Host "2. Login with above credentials"
          Write-Host "3. Look for XDumpGO folder on desktop"
          Write-Host "=========================================="
          
          $counter = 0
          while ($true) { 
              $counter++
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Runner active - $counter/‚àû - IP: $env:TAILSCALE_IP"
              Start-Sleep 300 
          }
