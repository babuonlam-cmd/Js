name: RDPXD

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
            -Name fDenyTSConnections -Value 0
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          Restart-Service TermService -Force

      - name: Create RDP User
        shell: pwsh
        run: |
          $user = "RDP"
          $pass = "Abc@1234Xy!"

          net user $user /delete 2>$null
          net user $user $pass /add
          net localgroup Administrators $user /add
          net localgroup "Remote Desktop Users" $user /add

          echo "RDP_USER=$user" >> $env:GITHUB_ENV
          echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

      - name: Install 7-Zip for RAR extraction
        shell: pwsh
        run: |
          $7zUrl = "https://www.7-zip.org/a/7z2407-x64.exe"
          $7zPath = "$env:TEMP\7z.exe"
          Invoke-WebRequest -Uri $7zUrl -OutFile $7zPath
          Start-Process -FilePath $7zPath -ArgumentList "/S" -Wait
          Write-Host "7-Zip installed successfully"

      - name: Download XDumpGO RAR from MediaFire
        shell: pwsh
        run: |
          # Direct download link
          $directUrl = "https://download2264.mediafire.com/m6jgrzle2lveqe2/x10g5we6bis/XDumpGO.rar"
          $rarPath = "C:\XDumpGO.rar"
          
          Write-Host "Downloading XDumpGO RAR..."
          try {
              Invoke-WebRequest -Uri $directUrl -OutFile $rarPath
          } catch {
              Write-Host "Direct download failed, trying alternative..."
              $mediafireUrl = "https://www.mediafire.com/file/m6jgrzle2lveqe2/XDumpGO.rar/file?dkey=x10g5we6bis&r=1279"
              Invoke-WebRequest -Uri $mediafireUrl -OutFile $rarPath
          }
          
          if (Test-Path $rarPath) {
              $fileSize = (Get-Item $rarPath).Length
              Write-Host "‚úÖ Download successful: $fileSize bytes"
          } else {
              Write-Host "‚ö†Ô∏è Download may have failed"
          }

      - name: Extract XDumpGO to Correct Location
        shell: pwsh
        run: |
          $rarPath = "C:\XDumpGO.rar"
          $extractPath = "C:\Users\RDP\Desktop\XDumpGO"
          
          # Create RDP user desktop folder
          New-Item -ItemType Directory -Path "C:\Users\RDP\Desktop" -Force | Out-Null
          
          if (Test-Path $rarPath) {
              Write-Host "Extracting XDumpGO to desktop..."
              
              # First extract to temp location
              $tempPath = "C:\TempXDumpGO"
              New-Item -ItemType Directory -Path $tempPath -Force | Out-Null
              & "C:\Program Files\7-Zip\7z.exe" x $rarPath -o"$tempPath" -y
              
              # Check what was extracted
              Write-Host "Checking extracted files..."
              Get-ChildItem $tempPath -Recurse | Select-Object -First 10 FullName | Format-Table
              
              # Find XDumpGO.exe
              $exeFiles = Get-ChildItem $tempPath -Filter "*.exe" -Recurse
              if ($exeFiles) {
                  Write-Host "Found executables:"
                  $exeFiles | Select-Object Name, FullName | Format-Table
                  
                  # Find main executable
                  $mainExe = $exeFiles | Where-Object { $_.Name -eq "XDumpGO.exe" } | Select-Object -First 1
                  
                  if ($mainExe) {
                      Write-Host "‚úÖ Found XDumpGO.exe at: $($mainExe.FullName)"
                      
                      # Get the directory containing XDumpGO.exe
                      $sourceDir = $mainExe.DirectoryName
                      
                      # Move everything to desktop
                      Write-Host "Moving files to desktop..."
                      Copy-Item -Path "$sourceDir\*" -Destination $extractPath -Recurse -Force
                      
                      # Cleanup
                      Remove-Item $tempPath -Recurse -Force
                      Remove-Item $rarPath -Force
                      
                      Write-Host "‚úÖ Extraction complete to: $extractPath"
                  } else {
                      Write-Host "‚ö†Ô∏è XDumpGO.exe not found, moving all files"
                      Move-Item -Path "$tempPath\*" -Destination $extractPath -Force
                      Remove-Item $tempPath -Recurse -Force
                  }
              }
          } else {
              Write-Host "‚ö†Ô∏è RAR file not found"
          }

      - name: Setup XDumpGO Auto-Start
        shell: pwsh
        run: |
          $xdumpgoPath = "C:\Users\RDP\Desktop\XDumpGO\XDumpGO.exe"
          
          Write-Host "Checking for XDumpGO at: $xdumpgoPath"
          
          if (Test-Path $xdumpgoPath) {
              Write-Host "‚úÖ Found XDumpGO.exe!"
              
              # 1. Start XDumpGO
              Write-Host "üöÄ Starting XDumpGO..."
              try {
                  $process = Start-Process -FilePath $xdumpgoPath -WindowStyle Normal -PassThru
                  Write-Host "Started with PID: $($process.Id)"
              } catch {
                  Write-Host "‚ö†Ô∏è Could not start: $_"
              }
              
              # 2. Create shortcut
              Write-Host "Creating shortcut..."
              $WshShell = New-Object -ComObject WScript.Shell
              $Shortcut = $WshShell.CreateShortcut("C:\Users\Public\Desktop\XDumpGO.lnk")
              $Shortcut.TargetPath = $xdumpgoPath
              $Shortcut.WorkingDirectory = "C:\Users\RDP\Desktop\XDumpGO"
              $Shortcut.Save()
              
              # 3. Add to startup
              Write-Host "Adding to startup..."
              reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v XDumpGO /t REG_SZ /d "`"$xdumpgoPath`"" /f
              
              Write-Host "‚úÖ Setup complete!"
          } else {
              Write-Host "‚ùå XDumpGO.exe not found. Searching..."
              
              $foundFiles = Get-ChildItem "C:\" -Filter "XDumpGO.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 5
              if ($foundFiles) {
                  Write-Host "Found XDumpGO.exe in these locations:"
                  $foundFiles | Select-Object FullName | Format-Table
                  
                  $actualPath = $foundFiles[0].FullName
                  Write-Host "Using: $actualPath"
                  
                  $WshShell = New-Object -ComObject WScript.Shell
                  $Shortcut = $WshShell.CreateShortcut("C:\Users\Public\Desktop\XDumpGO.lnk")
                  $Shortcut.TargetPath = $actualPath
                  $Shortcut.WorkingDirectory = Split-Path $actualPath -Parent
                  $Shortcut.Save()
              } else {
                  Write-Host "No XDumpGO.exe found"
              }
          }

      - name: Simple XDumpGO Starter
        shell: pwsh
        run: |
          Write-Host "Setting up XDumpGO starter"
          
          $starterScript = @'
@echo off
echo Starting XDumpGO...
cd /d "C:\Users\RDP\Desktop\XDumpGO"
start XDumpGO.exe
echo If XDumpGO doesn't start, try running as administrator
pause
'@
          
          $starterScript | Out-File "C:\Users\Public\Desktop\Start_XDumpGO.bat" -Encoding ASCII
          Write-Host "Created starter batch file"

      - name: Install Tailscale
        shell: pwsh
        run: |
          Write-Host "Installing Tailscale..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $path = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $path
          Start-Process msiexec.exe -ArgumentList "/i `"$path`" /quiet /norestart" -Wait

      - name: Connect Tailscale
        shell: pwsh
        run: |
          Write-Host "Connecting Tailscale..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=gh-rdp-$env:GITHUB_RUN_ID
          
          Start-Sleep 10
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "‚úÖ Tailscale connected with IP: $ip"

      - name: Show RDP Details
        shell: pwsh
        run: |
          Write-Host "=========================================="
          Write-Host "           RDP ACCESS READY               "
          Write-Host "=========================================="
          Write-Host "RDP IP Address : $env:TAILSCALE_IP"
          Write-Host "Username       : $env:RDP_USER"
          Write-Host "Password       : $env:RDP_PASS"
          Write-Host "------------------------------------------"
          Write-Host "XDumpGO Setup:"
          
          $xdumpgoPath1 = "C:\Users\RDP\Desktop\XDumpGO\XDumpGO.exe"
          $xdumpgoPath2 = "C:\Users\RDP\Desktop\XDumpGO\XDumpGO\XDumpGO.exe"
          
          if (Test-Path $xdumpgoPath1) {
              Write-Host "- ‚úÖ Location 1: $xdumpgoPath1"
          }
          if (Test-Path $xdumpgoPath2) {
              Write-Host "- ‚úÖ Location 2: $xdumpgoPath2"
          }
          
          Write-Host "- üìÅ Check both paths above"
          Write-Host "- üîó Desktop shortcut available"
          Write-Host "- üöÄ Starter batch file created"
          Write-Host "------------------------------------------"
          Write-Host "To Use XDumpGO:"
          Write-Host "1. Connect via RDP to: $env:TAILSCALE_IP"
          Write-Host "2. Login with above credentials"
          Write-Host "3. Look for XDumpGO shortcut on desktop"
          Write-Host "4. Or run Start_XDumpGO.bat on desktop"
          Write-Host "=========================================="
          
          $counter = 0
          while ($true) { 
              $counter++
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP Ready - Run #$counter - IP: $env:TAILSCALE_IP"
              Start-Sleep 60
          }
