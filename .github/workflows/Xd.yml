name: RDPXD

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
            -Name fDenyTSConnections -Value 0
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          Restart-Service TermService -Force

      - name: Create RDP User
        shell: pwsh
        run: |
          $user = "RDP"
          $pass = "Abc@1234Xy!"

          net user $user /delete 2>$null
          net user $user $pass /add
          net localgroup Administrators $user /add
          net localgroup "Remote Desktop Users" $user /add

          echo "RDP_USER=$user" >> $env:GITHUB_ENV
          echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

      - name: Install 7-Zip
        shell: pwsh
        run: |
          Invoke-WebRequest https://www.7-zip.org/a/7z2407-x64.exe -OutFile $env:TEMP\7z.exe
          Start-Process $env:TEMP\7z.exe -ArgumentList "/S" -Wait

      - name: Try MediaFire Auto Download
        shell: pwsh
        run: |
          $url = "https://www.mediafire.com/file/m6jgrzle2lveqe2/XDumpGO.rar/file?download=1"
          $out = "C:\Users\Public\Desktop\XDumpGO.rar"

          Write-Host "Trying MediaFire auto-download..."
          try {
            Start-BitsTransfer -Source $url -Destination $out -ErrorAction Stop
          } catch {
            Write-Host "Auto download blocked by MediaFire"
          }

          if (Test-Path $out) {
            Write-Host "Auto download successful"
          } else {
            Write-Host "Creating manual download instructions..."
            @"
MANUAL DOWNLOAD REQUIRED

1. Open browser in RDP
2. Go to:
https://www.mediafire.com/file/m6jgrzle2lveqe2/XDumpGO.rar/file
3. Click DOWNLOAD
4. Save to Desktop
5. Extract using 7-Zip
6. Run XDumpGO.exe

NOTE:
MediaFire blocks automation. This is normal.
"@ | Out-File "C:\Users\Public\Desktop\READ_ME_DOWNLOAD.txt" -Encoding UTF8
          }

      - name: Prepare Desktop Folder
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "C:\Users\RDP\Desktop\XDumpGO" -Force | Out-Null

      - name: Install Tailscale
        shell: pwsh
        run: |
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi `
            -OutFile $env:TEMP\tailscale.msi
          Start-Process msiexec.exe -ArgumentList "/i `"$env:TEMP\tailscale.msi`" /quiet /norestart" -Wait

      - name: Connect Tailscale
        shell: pwsh
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=gh-rdp-$env:GITHUB_RUN_ID

          Start-Sleep 10
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: Show RDP Details
        shell: pwsh
        run: |
          Write-Host "===================================="
          Write-Host "RDP READY"
          Write-Host "IP       : $env:TAILSCALE_IP"
          Write-Host "USER     : $env:RDP_USER"
          Write-Host "PASS     : $env:RDP_PASS"
          Write-Host "------------------------------------"
          Write-Host "If XDumpGO.rar not found:"
          Write-Host "- Open Desktop"
          Write-Host "- Read READ_ME_DOWNLOAD.txt"
          Write-Host "- Download manually via browser"
          Write-Host "===================================="

          while ($true) {
            Start-Sleep 300
          }
