name: RDP with XDumpGO

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable Remote Desktop
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Restart-Service TermService -Force

      - name: Create RDP User
        shell: pwsh
        run: |
          $user = "RDP"
          $pass = "Abc@1234Xy!"
          
          # Delete if exists, then create
          net user $user /delete 2>$null
          net user $user $pass /add
          net localgroup Administrators $user /add
          net localgroup "Remote Desktop Users" $user /add
          
          # Save to environment
          echo "RDP_USER=$user" >> $env:GITHUB_ENV
          echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

      - name: Download XDumpGO Parts
        shell: pwsh
        run: |
          $url = "https://github.com/babuonlam-cmd/Js/raw/main/XDumpGO.zip"
          
          # Download both parts
          Invoke-WebRequest "$url.t0.001" -OutFile "p1"
          Invoke-WebRequest "$url.t0.002" -OutFile "p2"
          
          # Combine parts
          $f1 = [System.IO.File]::ReadAllBytes("p1")
          $f2 = [System.IO.File]::ReadAllBytes("p2")
          $combined = $f1 + $f2
          [System.IO.File]::WriteAllBytes("XDumpGO.zip", $combined)
          
          # Extract
          Expand-Archive -Path "XDumpGO.zip" -DestinationPath "C:\XDumpGO" -Force
          
          # Cleanup
          Remove-Item "p1", "p2", "XDumpGO.zip" -Force

      - name: Start XDumpGO Application
        shell: pwsh
        run: |
          # Start XDumpGO
          Start-Process "C:\XDumpGO\XDumpGO.exe"
          
          # Create desktop shortcut
          $ws = New-Object -ComObject WScript.Shell
          $sc = $ws.CreateShortcut("C:\Users\Public\Desktop\XDumpGO.lnk")
          $sc.TargetPath = "C:\XDumpGO\XDumpGO.exe"
          $sc.WorkingDirectory = "C:\XDumpGO"
          $sc.Save()
          
          Write-Host "XDumpGO started and shortcut created"

      - name: Install Tailscale VPN
        shell: pwsh
        run: |
          # Download and install Tailscale
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi"
          $tsPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest $tsUrl -OutFile $tsPath
          Start-Process msiexec.exe -ArgumentList "/i `"$tsPath`" /quiet /norestart" -Wait
          
          # Wait for installation
          Start-Sleep -Seconds 10

      - name: Connect Tailscale Network
        shell: pwsh
        run: |
          # Connect to Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=github-rdp-machine
            
          # Get Tailscale IP
          Start-Sleep -Seconds 5
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          
          Write-Host "Connected to Tailscale with IP: $ip"

      - name: Display Connection Information
        shell: pwsh
        run: |
          Write-Host "=========================================="
          Write-Host "      RDP CONNECTION ESTABLISHED          "
          Write-Host "=========================================="
          Write-Host "RDP Address: $env:TAILSCALE_IP"
          Write-Host "Username   : $env:RDP_USER"
          Write-Host "Password   : $env:RDP_PASS"
          Write-Host ""
          Write-Host "XDumpGO Status:"
          Write-Host "- Application is running"
          Write-Host "- Desktop shortcut available"
          Write-Host "- Location: C:\XDumpGO\XDumpGO.exe"
          Write-Host ""
          Write-Host "To connect:"
          Write-Host "1. Use Remote Desktop Connection"
          Write-Host "2. Enter IP: $env:TAILSCALE_IP"
          Write-Host "3. Use credentials above"
          Write-Host "4. XDumpGO will be on desktop"
          Write-Host "=========================================="
          
          # Keep the workflow running
          $counter = 1
          while ($true) {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP active for $(($counter * 5)) minutes"
              $counter++
              Start-Sleep -Seconds 300
          }
